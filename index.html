<script>
function exportExcel() {
  let db = JSON.parse(localStorage.getItem("rekapAll")) || {};
  let pilih = document.getElementById("pilihReseller").value;
  let dataExport = [];

  if (pilih === "all") {
    // REKAP SEMUA RESELLER
    for (let r in db) {
      let totalTerjual = 0, totalBayar = 0, totalKomisi = 0;
      let row = { Reseller: r };

      ["2000","3000","5000","20000","50000"].forEach(jenis => row["V"+jenis] = 0);

      db[r].forEach(entry => {
        for (let jenis in entry.rekap) {
          row["V"+jenis] += entry.rekap[jenis].terjual;
          totalTerjual += entry.rekap[jenis].terjual;
        }
        totalBayar += entry.total;
        totalKomisi += entry.komisi;
      });

      row["Total_Terjual"] = totalTerjual;
      row["Jumlah_Bayar"] = totalBayar;
      row["Komisi"] = totalKomisi;

      dataExport.push(row);
    }

  } else {
    // DETAIL RESELLER TERTENTU
    (db[pilih] || []).forEach(entry => {
      for (let jenis in entry.rekap) {
        let rk = entry.rekap[jenis];
        dataExport.push({
          "Tanggal Rekap": entry.tanggal,
          "Reseller": pilih,
          "Jenis": jenis,
          "QTY": rk.qty,
          "SISA": rk.sisa,
          "TERJUAL": rk.terjual,
          "JUMLAH_BAYAR": rk.bayar,
          "Total": entry.total,
          "Komisi": entry.komisi
        });
      }
    });
  }

  if (dataExport.length === 0) {
    alert("⚠️ Tidak ada data untuk diexport!");
    return;
  }

  let ws = XLSX.utils.json_to_sheet(dataExport);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Rekap");
  XLSX.writeFile(wb, "Rekap_Voucher.xlsx");
}

function exportPDF() {
  let db = JSON.parse(localStorage.getItem("rekapAll")) || {};
  let pilih = document.getElementById("pilihReseller").value;
  let body = [];
  let head = [];

  const { jsPDF } = window.jspdf;
  let doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("Rekap Penjualan Voucher AGAM.NET", 20, 20);

  if (pilih === "all") {
    head = [["Reseller","V2000","V3000","V5000","V20000","V50000","Total Terjual","Jumlah Bayar","Komisi"]];

    for (let r in db) {
      let totalTerjual = 0, totalBayar = 0, totalKomisi = 0;
      let row = [r,0,0,0,0,0,0,0,0];

      db[r].forEach(entry => {
        for (let jenis in entry.rekap) {
          let idx = ["2000","3000","5000","20000","50000"].indexOf(jenis);
          if (idx >= 0) {
            row[idx+1] += entry.rekap[jenis].terjual;
            totalTerjual += entry.rekap[jenis].terjual;
          }
        }
        totalBayar += entry.total;
        totalKomisi += entry.komisi;
      });

      row[6] = totalTerjual;
      row[7] = totalBayar.toLocaleString("id-ID");
      row[8] = totalKomisi.toLocaleString("id-ID");
      body.push(row);
    }

  } else {
    head = [["Tanggal","Reseller","Jenis","QTY","SISA","TERJUAL","JUMLAH BAYAR","Total","Komisi"]];

    (db[pilih] || []).forEach(entry => {
      for (let jenis in entry.rekap) {
        let rk = entry.rekap[jenis];
        body.push([
          entry.tanggal,
          pilih,
          jenis,
          rk.qty,
          rk.sisa,
          rk.terjual,
          rk.bayar.toLocaleString("id-ID"),
          entry.total.toLocaleString("id-ID"),
          entry.komisi.toLocaleString("id-ID")
        ]);
      }
    });

    // tambahkan header di atas tabel
    doc.setFontSize(12);
    doc.text("Tanggal Rekap: " + (db[pilih]?.[0]?.tanggal || "-"), 20, 30);
    doc.text("Reseller: " + pilih, 20, 37);
  }

  doc.autoTable({
    head: head,
    body: body,
    startY: pilih === "all" ? 30 : 45,
    styles: { fontSize: 10 }
  });

  doc.save("Rekap_Voucher.pdf");
}
</script>
